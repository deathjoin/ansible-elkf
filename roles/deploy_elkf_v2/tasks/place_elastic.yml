---
# item.0 — node index
# item.1 — one of play host from inventory

- name: "Place Elastic {{ elkf_stack_nodename_prefix_elastic ~ item.0 }} on {{ item.1 }}"
  set_fact:
    elkf_services_elastic: "{{ hostvars[item.1]['elkf_services_elastic'] + [elkf_stack_nodename_prefix_elastic ~ item.0] }}"
    elkf_remaining_memory: "{{ hostvars[item.1]['elkf_remaining_memory']|int - elkf_stack_memory_elasticsearch|int }}"
  delegate_to: "{{ item.1 }}"
  delegate_facts: true
  when: 
  - "hostvars[item.1]['elkf_remaining_memory']|int > elkf_stack_memory_elasticsearch|int"
  - "(elkf_stack_nodename_prefix_elastic ~ item.0) not in (play_hosts | map('extract', hostvars) | map(attribute='elkf_services_elastic') | flatten )"